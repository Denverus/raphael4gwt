/*! raphael4gwt 2013-08-26 */
Raphael.fn.freeTransform=function(a,b,c){function d(){var a={x:j.attrs.rotate*Math.PI/180,y:(j.attrs.rotate+90)*Math.PI/180},b={x:j.attrs.size.x/2*j.attrs.scale.x,y:j.attrs.size.y/2*j.attrs.scale.y},c=[],d=[{x:-1,y:-1},{x:1,y:-1},{x:1,y:1},{x:-1,y:1}];return d.map(function(d){c.push({x:j.attrs.center.x+j.attrs.translate.x+d.x*b.x*Math.cos(a.x)+d.y*b.y*Math.cos(a.y),y:j.attrs.center.y+j.attrs.translate.y+d.x*b.x*Math.sin(a.x)+d.y*b.y*Math.sin(a.y)})}),c}function e(a){if(a&&j.opts.snap.drag){var b=a.x,c=a.y,d={x:0,y:0},e={x:0,y:0};[0,1].map(function(){d.x=b-Math.round(b/j.opts.snap.drag)*j.opts.snap.drag,d.y=c-Math.round(c/j.opts.snap.drag)*j.opts.snap.drag,Math.abs(d.x)<=j.opts.snapDist.drag&&(e.x=d.x),Math.abs(d.y)<=j.opts.snapDist.drag&&(e.y=d.y),b+=a.width-e.x,c+=a.height-e.y}),j.attrs.translate.x-=e.x,j.attrs.translate.y-=e.y}if(j.opts.boundary){var f=j.opts.boundary;j.attrs.center.x+j.attrs.translate.x<f.x&&(j.attrs.translate.x+=f.x-(j.attrs.center.x+j.attrs.translate.x)),j.attrs.center.y+j.attrs.translate.y<f.y&&(j.attrs.translate.y+=f.y-(j.attrs.center.y+j.attrs.translate.y)),j.attrs.center.x+j.attrs.translate.x>f.x+f.width&&(j.attrs.translate.x+=f.x+f.width-(j.attrs.center.x+j.attrs.translate.x)),j.attrs.center.y+j.attrs.translate.y>f.y+f.height&&(j.attrs.translate.y+=f.y+f.height-(j.attrs.center.y+j.attrs.translate.y))}if(j.opts.keepRatio&&(j.attrs.scale.x=j.attrs.scale.y),d=Math.abs(j.attrs.rotate%j.opts.snap.rotate),d=Math.min(d,j.opts.snap.rotate-d),d<j.opts.snapDist.rotate&&(j.attrs.rotate=Math.round(j.attrs.rotate/j.opts.snap.rotate)*j.opts.snap.rotate),d={x:Math.abs(j.attrs.scale.x*j.attrs.size.x%j.opts.snap.scale),y:Math.abs(j.attrs.scale.y*j.attrs.size.x%j.opts.snap.scale)},d={x:Math.min(d.x,j.opts.snap.scale-d.x),y:Math.min(d.y,j.opts.snap.scale-d.y)},d.x<j.opts.snapDist.scale&&(j.attrs.scale.x=Math.round(j.attrs.scale.x*j.attrs.size.x/j.opts.snap.scale)*j.opts.snap.scale/j.attrs.size.x),d.y<j.opts.snapDist.scale&&(j.attrs.scale.y=Math.round(j.attrs.scale.y*j.attrs.size.y/j.opts.snap.scale)*j.opts.snap.scale/j.attrs.size.y),j.opts.range.rotate){var g=(360+j.attrs.rotate)%360;g>180&&(g-=360),g<j.opts.range.rotate[0]&&(j.attrs.rotate+=j.opts.range.rotate[0]-g),g>j.opts.range.rotate[1]&&(j.attrs.rotate+=j.opts.range.rotate[1]-g)}j.opts.range.scale&&(j.attrs.scale.x*j.attrs.size.x<j.opts.range.scale[0]&&(j.attrs.scale.x=j.opts.range.scale[0]/j.attrs.size.x),j.attrs.scale.y*j.attrs.size.y<j.opts.range.scale[0]&&(j.attrs.scale.y=j.opts.range.scale[0]/j.attrs.size.y),j.attrs.scale.x*j.attrs.size.x>j.opts.range.scale[1]&&(j.attrs.scale.x=j.opts.range.scale[1]/j.attrs.size.x),j.attrs.scale.y*j.attrs.size.y>j.opts.range.scale[1]&&(j.attrs.scale.y=j.opts.range.scale[1]/j.attrs.size.y))}function f(a){var b,c={};for(b in a)c[b]="object"==typeof a[b]?f(a[b]):a[b];return c}function g(a){if(j.callback){var b=[];a.map(function(a){a&&b.push(a)}),clearTimeout(k),setTimeout(function(){j.callback&&j.callback(j,b)},1)}}if(a.freeTransform)return a.freeTransform;Array.prototype.hasOwnProperty("map")||(Array.prototype.map=function(a,b){var c,d=[];for(c in this)this.hasOwnProperty(c)&&(d[c]=a.call(b,this[c],c,this));return d}),Array.prototype.hasOwnProperty("indexOf")||(Array.prototype.indexOf=function(a,b){for(var c=b||0,d=this.length;d>c;c++)if(this[c]===a)return c;return-1});var h=this,i=a.getBBox(!0),j=a.freeTransform={attrs:{x:i.x,y:i.y,size:{x:i.width,y:i.height},center:{x:i.x+i.width/2,y:i.y+i.height/2},rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},axes:null,bbox:null,callback:null,items:[],handles:{center:null,x:null,y:null},offset:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},opts:{animate:!1,attrs:{fill:"#fff",stroke:"#000"},boundary:{x:h._left||0,y:h._top||0,width:h.width,height:h.height},distance:1.3,drag:!0,draw:!1,keepRatio:!1,range:{rotate:[-180,180],scale:[0,99999]},rotate:!0,scale:!0,snap:{rotate:0,scale:0,drag:0},snapDist:{rotate:0,scale:0,drag:7},size:5},subject:a};j.updateHandles=function(){if(j.handles.bbox||j.opts.rotate.indexOf("self")>=0)var a=d();var b={x:j.attrs.rotate*Math.PI/180,y:(j.attrs.rotate+90)*Math.PI/180},c={x:j.attrs.size.x/2*j.attrs.scale.x,y:j.attrs.size.y/2*j.attrs.scale.y};if(j.axes.map(function(a){if(j.handles[a]){var d=j.attrs.center.x+j.attrs.translate.x+c[a]*j.opts.distance*Math.cos(b[a]),e=j.attrs.center.y+j.attrs.translate.y+c[a]*j.opts.distance*Math.sin(b[a]);j.opts.boundary&&(d=Math.max(Math.min(d,j.opts.boundary.x+j.opts.boundary.width),j.opts.boundary.x),e=Math.max(Math.min(e,j.opts.boundary.y+j.opts.boundary.height),j.opts.boundary.y)),j.handles[a].disc.attr({cx:d,cy:e}),j.handles[a].line.toFront().attr({path:[["M",j.attrs.center.x+j.attrs.translate.x,j.attrs.center.y+j.attrs.translate.y],["L",j.handles[a].disc.attrs.cx,j.handles[a].disc.attrs.cy]]}),j.handles[a].disc.toFront()}}),j.bbox){j.bbox.toFront().attr({path:[["M",a[0].x,a[0].y],["L",a[1].x,a[1].y],["L",a[2].x,a[2].y],["L",a[3].x,a[3].y],["L",a[0].x,a[0].y]]});var e=[[-1,-1],[1,-1],[1,1],[-1,1],[0,-1],[1,0],[0,1],[-1,0]];j.handles.bbox&&j.handles.bbox.map(function(b,c){var d,f,g,h;4>c?(d=a[c].x,f=a[c].y):(g=c%4,h=(g+1)%a.length,d=(a[g].x+a[h].x)/2,f=(a[g].y+a[h].y)/2),b.element.toFront().attr({x:d-j.opts.size,y:f-j.opts.size}).transform("R"+j.attrs.rotate),b.x=e[c][0],b.y=e[c][1]})}j.circle&&j.circle.attr({cx:j.attrs.center.x+j.attrs.translate.x,cy:j.attrs.center.y+j.attrs.translate.y,r:Math.max(c.x,c.y)*j.opts.distance}),j.handles.center&&j.handles.center.disc.toFront().attr({cx:j.attrs.center.x+j.attrs.translate.x,cy:j.attrs.center.y+j.attrs.translate.y}),j.opts.rotate.indexOf("self")>=0&&(c=Math.max(Math.sqrt(Math.pow(a[1].x-a[0].x,2)+Math.pow(a[1].y-a[0].y,2)),Math.sqrt(Math.pow(a[2].x-a[1].x,2)+Math.pow(a[2].y-a[1].y,2)))/2)},j.showHandles=function(){if(j.hideHandles(),j.axes.map(function(a){j.handles[a]={},j.handles[a].line=h.path(["M",j.attrs.center.x,j.attrs.center.y]).attr({stroke:j.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.5}),j.handles[a].disc=h.circle(j.attrs.center.x,j.attrs.center.y,j.opts.size).attr(j.opts.attrs)}),j.opts.draw.indexOf("bbox")>=0){j.bbox=h.path("").attr({stroke:j.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.5}),j.handles.bbox=[];var b;for(b=j.opts.scale.indexOf("bboxCorners")>=0?0:4;b<(j.opts.keepRatio||-1===j.opts.scale.indexOf("bboxSides")?4:8);b++)j.handles.bbox[b]={},j.handles.bbox[b].element=h.rect(j.attrs.center.x,j.attrs.center.y,2*j.opts.size,2*j.opts.size).attr(j.opts.attrs)}j.opts.draw.indexOf("circle")>=0&&(j.circle=h.circle(0,0,0).attr({stroke:j.opts.attrs.stroke,"stroke-dasharray":"- ",opacity:.3})),j.opts.drag.indexOf("center")>=0&&(j.handles.center={},j.handles.center.disc=h.circle(j.attrs.center.x,j.attrs.center.y,j.opts.size).attr(j.opts.attrs)),j.axes.map(function(a){if(j.handles[a]){var b=j.opts.rotate.indexOf("axis"+a.toUpperCase())>=0,c=j.opts.scale.indexOf("axis"+a.toUpperCase())>=0;j.handles[a].disc.drag(function(d,f){j.o.viewBoxRatio&&(d*=j.o.viewBoxRatio.x,f*=j.o.viewBoxRatio.y);var h=d+j.handles[a].disc.ox,i=f+j.handles[a].disc.oy,k={x:j.o.scale.x<0,y:j.o.scale.y<0};if(b){var l=Math.atan2(i-j.o.center.y-j.o.translate.y,h-j.o.center.x-j.o.translate.x);j.attrs.rotate=180*l/Math.PI-("y"===a?90:0),k[a]&&(j.attrs.rotate-=180)}j.opts.boundary&&(h=Math.max(Math.min(h,j.opts.boundary.x+j.opts.boundary.width),j.opts.boundary.x),i=Math.max(Math.min(i,j.opts.boundary.y+j.opts.boundary.height),j.opts.boundary.y));var m=Math.sqrt(Math.pow(h-j.o.center.x-j.o.translate.x,2)+Math.pow(i-j.o.center.y-j.o.translate.y,2));c&&(j.attrs.scale=j.opts.keepRatio?{x:m/(j.o.size[a]/2*j.opts.distance),y:m/(j.o.size[a]/2*j.opts.distance)}:{x:"x"===a?m/(j.o.size.x/2*j.opts.distance):j.o.scale.x,y:"y"===a?m/(j.o.size.y/2*j.opts.distance):j.o.scale.y},k[a]&&(j.attrs.scale[a]*=-1)),e(),j.attrs.scale.x&&j.attrs.scale.y&&j.apply(),g([b?"rotate":null,c?"scale":null])},function(){j.o=f(j.attrs),h._viewBox&&(j.o.viewBoxRatio={x:h._viewBox[2]/h.width,y:h._viewBox[3]/h.height}),j.handles[a].disc.ox=this.attrs.cx,j.handles[a].disc.oy=this.attrs.cy,g([b?"rotate start":null,c?"scale start":null])},function(){g([b?"rotate end":null,c?"scale end":null])})}}),j.opts.draw.indexOf("bbox")>=0&&(j.opts.scale.indexOf("bboxCorners")>=0||j.opts.scale.indexOf("bboxSides")>=0)&&j.handles.bbox.map(function(a){a.element.drag(function(b,c){var d,f,h,i,k,l,m,n,o=j.o.rotate.sin,p=j.o.rotate.cos;j.o.viewBoxRatio&&(b*=j.o.viewBoxRatio.x,c*=j.o.viewBoxRatio.y),d=b*p-c*o,f=b*o+c*p,j.opts.keepRatio&&(d=f*(a.x*a.y<0?-1:1)),d*=Math.abs(a.x),f*=Math.abs(a.y),h=d*p+f*o,i=d*-o+f*p,j.attrs.translate={x:j.o.translate.x+h/2,y:j.o.translate.y+i/2},k=j.o.handlePos.cx+b-j.attrs.center.x-j.attrs.translate.x,l=j.o.handlePos.cy+c-j.attrs.center.y-j.attrs.translate.y,d=k*p-l*o,f=k*o+l*p,m=2*d*a.x/j.o.size.x,n=2*f*a.y/j.o.size.y,j.attrs.scale={x:m||j.o.scale.x,y:n||j.o.scale.y},e(),j.apply(),g(["scale"])},function(){var b=(360-j.attrs.rotate)%360/180*Math.PI,c=a.element.attr(["x","y"]);j.o=f(j.attrs),j.o.handlePos={cx:c.x+j.opts.size,cy:c.y+j.opts.size},j.o.rotate={sin:Math.sin(b),cos:Math.cos(b)},h._viewBox&&(j.o.viewBoxRatio={x:h._viewBox[2]/h.width,y:h._viewBox[3]/h.height}),g(["scale start"])},function(){g(["scale end"])})});var c=[];j.opts.drag.indexOf("self")>=0&&-1===j.opts.scale.indexOf("self")&&-1===j.opts.rotate.indexOf("self")&&c.push(a),j.opts.drag.indexOf("center")>=0&&c.push(j.handles.center.disc),c.map(function(b){b.drag(function(a,b){j.o.viewBoxRatio&&(a*=j.o.viewBoxRatio.x,b*=j.o.viewBoxRatio.y),j.attrs.translate.x=j.o.translate.x+a,j.attrs.translate.y=j.o.translate.y+b;var c=f(j.o.bbox);c.x+=a,c.y+=b,e(c),j.apply(),g(["drag"])},function(){j.o=f(j.attrs),j.opts.snap.drag&&(j.o.bbox=a.getBBox()),h._viewBox&&(j.o.viewBoxRatio={x:h._viewBox[2]/h.width,y:h._viewBox[3]/h.height}),j.axes.map(function(a){j.handles[a]&&(j.handles[a].disc.ox=j.handles[a].disc.attrs.cx,j.handles[a].disc.oy=j.handles[a].disc.attrs.cy)}),g(["drag start"])},function(){g(["drag end"])})});var d=j.opts.rotate.indexOf("self")>=0,i=j.opts.scale.indexOf("self")>=0;(d||i)&&a.drag(function(a,b,c,f){if(d){var h=Math.atan2(f-j.o.center.y-j.o.translate.y,c-j.o.center.x-j.o.translate.x);j.attrs.rotate=j.o.rotate+180*h/Math.PI-j.o.deg}var k={x:j.o.scale.x<0,y:j.o.scale.y<0};if(i){var l=Math.sqrt(Math.pow(c-j.o.center.x-j.o.translate.x,2)+Math.pow(f-j.o.center.y-j.o.translate.y,2));j.attrs.scale.x=j.attrs.scale.y=(k.x?-1:1)*j.o.scale.x+(l-j.o.radius)/(j.o.size.x/2),k.x&&(j.attrs.scale.x*=-1),k.y&&(j.attrs.scale.y*=-1)}e(),j.apply(),g([d?"rotate":null,i?"scale":null])},function(a,b){j.o=f(j.attrs),j.o.deg=180*Math.atan2(b-j.o.center.y-j.o.translate.y,a-j.o.center.x-j.o.translate.x)/Math.PI,j.o.radius=Math.sqrt(Math.pow(a-j.o.center.x-j.o.translate.x,2)+Math.pow(b-j.o.center.y-j.o.translate.y,2)),h._viewBox&&(j.o.viewBoxRatio={x:h._viewBox[2]/h.width,y:h._viewBox[3]/h.height}),g([d?"rotate start":null,i?"scale start":null])},function(){g([d?"rotate end":null,i?"scale end":null])}),j.updateHandles()},j.hideHandles=function(){j.items.map(function(a){a.el.undrag()}),j.handles.center&&(j.handles.center.disc.remove(),j.handles.center=null),["x","y"].map(function(a){j.handles[a]&&(j.handles[a].disc.remove(),j.handles[a].line.remove(),j.handles[a]=null)}),j.bbox&&(j.bbox.remove(),j.bbox=null,j.handles.bbox&&(j.handles.bbox.map(function(a){a.element.remove()}),j.handles.bbox=null)),j.circle&&(j.circle.remove(),j.circle=null)},j.setOpts=function(a,b){j.callback="function"==typeof b?b:!1;var c,d;for(c in a)if(a[c]&&a[c].constructor===Object)for(d in a[c])a[c].hasOwnProperty(d)&&(j.opts[c][d]=a[c][d]);else j.opts[c]=a[c];j.opts.animate===!0&&(j.opts.animate={delay:700,easing:"linear"}),j.opts.drag===!0&&(j.opts.drag=["center","self"]),j.opts.rotate===!0&&(j.opts.rotate=["axisX","axisY"]),j.opts.scale===!0&&(j.opts.scale=["axisX","axisY","bboxCorners","bboxSides"]),["drag","draw","rotate","scale"].map(function(a){j.opts[a]===!1&&(j.opts[a]=[])}),j.opts.scale||(j.opts.keepRatio=!0),j.axes=[],(j.opts.rotate.indexOf("axisX")>=0||j.opts.scale.indexOf("axisX")>=0)&&j.axes.push("x"),(j.opts.rotate.indexOf("axisY")>=0||j.opts.scale.indexOf("axisY")>=0)&&j.axes.push("y"),["drag","rotate","scale"].map(function(a){j.opts.snapDist[a]||(j.opts.snapDist[a]=j.opts.snap[a])}),j.opts.range={rotate:[parseFloat(j.opts.range.rotate[0]),parseFloat(j.opts.range.rotate[1])],scale:[parseFloat(j.opts.range.scale[0]),parseFloat(j.opts.range.scale[1])]},j.opts.snap={drag:parseFloat(j.opts.snap.drag),rotate:parseFloat(j.opts.snap.rotate),scale:parseFloat(j.opts.snap.scale)},j.opts.snapDist={drag:parseFloat(j.opts.snapDist.drag),rotate:parseFloat(j.opts.snapDist.rotate),scale:parseFloat(j.opts.snapDist.scale)},j.opts.size=parseInt(j.opts.size),j.showHandles(),g(["init"])},j.setOpts(b,c),j.apply=function(){j.items.map(function(a,b){var c={x:j.attrs.center.x+j.offset.translate.x,y:j.attrs.center.y+j.offset.translate.y},d=j.attrs.rotate-j.offset.rotate,e={x:j.attrs.scale.x/j.offset.scale.x,y:j.attrs.scale.y/j.offset.scale.y},f={x:j.attrs.translate.x-j.offset.translate.x,y:j.attrs.translate.y-j.offset.translate.y};j.opts.animate?(g(["animate start"]),a.el.animate({transform:["R",d,c.x,c.y,"S",e.x,e.y,c.x,c.y,"T",f.x,f.y]+j.items[b].transformString},j.opts.animate.delay,j.opts.animate.easing,function(){g(["animate end"]),j.updateHandles()})):(a.el.transform(["R",d,c.x,c.y,"S",e.x,e.y,c.x,c.y,"T",f.x,f.y]+j.items[b].transformString),g(["apply"]),j.updateHandles())})},j.unplug=function(){var b=j.attrs;return j.hideHandles(),delete a.freeTransform,b},("set"===a.type?a.items:[a]).map(function(a){j.items.push({el:a,attrs:{rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},transformString:a.matrix.toTransformString()})}),j.items.map(function(a,b){a.el._&&a.el._.transform&&a.el._.transform.map(function(a){if(a[0])switch(a[0].toUpperCase()){case"T":j.items[b].attrs.translate.x+=a[1],j.items[b].attrs.translate.y+=a[2];break;case"S":j.items[b].attrs.scale.x*=a[1],j.items[b].attrs.scale.y*=a[2];break;case"R":j.items[b].attrs.rotate+=a[1]}})}),"set"!==a.type&&(j.attrs.rotate=j.items[0].attrs.rotate,j.attrs.scale=j.items[0].attrs.scale,j.attrs.translate=j.items[0].attrs.translate,j.items[0].attrs={rotate:0,scale:{x:1,y:1},translate:{x:0,y:0}},j.items[0].transformString="");var k=!1;return j.updateHandles(),j};